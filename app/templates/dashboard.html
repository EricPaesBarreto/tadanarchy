{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="container py-5">

  <!-- User Greeting -->
  <div class="mb-4 text-center">
    <h2>Welcome, {{ user.first_name }}! ðŸ‘‹</h2>
    <p class="text-muted">Here's a quick look at your activity today.</p>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-5">
    <div class="col-md-3">
      <div class="card shadow-sm text-center p-3">
        <h5>Total Points</h5>
        <span class="fs-3 fw-bold">{{ user.points or 0 }} ðŸª™</span>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm text-center p-3">
        <h5>Tasks Completed</h5>
        <span class="fs-3 fw-bold">{{ user.completed_tasks or 0 }}</span>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm text-center p-3">
        <h5>Family Members</h5>
        <span class="fs-3 fw-bold">{{ user.family_size or 1 }}</span>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm text-center p-3">
        <h5>Avatar</h5>
        <img src="{{ url_for('static', filename='avatars/pfp' ~ user.avatar_id ~ '.png') }}" 
             class="rounded-circle" width="50" height="50">
      </div>
    </div>
  </div>

  <!-- Family Tasks Section -->
  <div class="container py-5">
    <h3 class="fw-semibold mb-3">ðŸ‘ª Family Tasks</h3>

    <div id="familyTaskContainer" class="row g-3">
      <!-- Placeholder tasks -->
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Wash the dishes</h5>
            <p class="card-text">Uploaded by: Mom</p>
            <p class="card-text text-muted">Complete this task to earn 10 ðŸª™</p>
            <button class="btn btn-primary btn-sm claim-btn">Claim Task</button>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Take out the trash</h5>
            <p class="card-text">Uploaded by: Dad</p>
            <p class="card-text text-muted">Complete this task to earn 5 ðŸª™</p>
            <button class="btn btn-primary btn-sm claim-btn">Claim Task</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".claim-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const card = e.target.closest(".card");
          const taskName = card.querySelector(".card-title").textContent;
          alert(`You have claimed the task: ${taskName}`);
          // TODO: Add fetch/AJAX call to mark task as claimed in the DB
        });
      });
    });
  </script>


  <!-- Placeholder for tasks or recent activity -->
  <div class="mb-5">
    <h4>Recent Tasks</h4>
      <ul class="list-group">
        {% for task in user.tasks or [{'id': 0,'name': 'Placeholder Task 1', 'points': 10}, {'id':0,'name': 'Placeholder Task 2', 'points': 5}] %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ task.name }}
            <div>
              <span class="badge bg-primary rounded-pill me-2">{{ task.points }} ðŸª™</span>
              {% if not task.completed %}
              <button class="btn btn-success btn-sm mark-complete-btn" data-task-id="{{ task.id }}">
                âœ… Mark Complete
              </button>
              {% else %}
              <span class="text-success fw-bold">Completed</span>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
  </div>

  <!-- Placeholder charts or progress bars can go here -->

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".mark-complete-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const taskId = btn.dataset.taskId;
      const res = await fetch(`/task/${taskId}/complete`, { method: 'POST' });
      const data = await res.json();

      if (data.status === 'success') {
        btn.replaceWith('<span class="text-success fw-bold">Completed</span>');
        document.querySelector("#pointsBadge").textContent = data.new_points + " ðŸª™";
      } else if (data.status === 'already completed') {
        btn.replaceWith('<span class="text-success fw-bold">Completed</span>');
      }
    });
  });
});
</script>


{% endblock %}
