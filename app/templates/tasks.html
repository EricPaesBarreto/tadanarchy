{% extends "base.html" %}
{% block title %}Tasks{% endblock %}

{% block content %}
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-semibold">ðŸ“‹ Current Tasks for the Day</h3>
    <div>
      <button id="focusModeBtn" class="btn btn-warning btn-sm me-2">ðŸŽ¯ Enter Focus Mode</button>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newTaskModal">
        âž• Add New Task
      </button>
    </div>
  </div>


  <!-- Today's Task / Stats -->
  <div class="mb-4 p-4 bg-light rounded shadow-sm">
    <h3 class="fw-semibold">ðŸ“… Today's Tasks</h3>
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div>
        <p class="mb-1">Total Tasks: <strong id="totalTasks">0</strong></p>
        <p class="mb-0">Total Points: <strong id="totalPoints">0</strong> ðŸª™</p>
      </div>
      <button class="btn btn-success" id="uploadFamilyBtn" onclick="location.href='{{ url_for('main.dashboard') }}';">
      ðŸ“¤ Upload to Dashboard
    </button>
    </div>
  </div>

  <!-- Add New Task Button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-semibold">All Tasks</h4>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newTaskModal">
      âž• Add New Task
    </button>
  </div>

  <!-- Task List -->
  <div id="taskContainer" class="row g-3"></div>

</div>

<!-- Modals -->
<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTaskModalLabel">Add New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="taskName" class="form-label">Task Name</label>
          <input type="text" class="form-control" id="taskName">
        </div>
        <div class="mb-3">
          <label for="taskPoints" class="form-label">Points</label>
          <input type="number" class="form-control" id="taskPoints" value="0">
        </div>
        <div class="mb-3">
          <label for="taskDeadline" class="form-label">Deadline</label>
          <input type="datetime-local" class="form-control" id="taskDeadline">
        </div>
        <div class="mb-3">
          <label for="taskSteps" class="form-label">Steps (comma separated)</label>
          <input type="text" class="form-control" id="taskSteps">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveTaskBtn">Save Task</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    let taskCount = 0;
    const taskContainer = document.getElementById("taskContainer");
    const totalTasksEl = document.getElementById("totalTasks");
    const totalPointsEl = document.getElementById("totalPoints");

    let totalPoints = 0;

    const placeholderTasks = [
        { name: "Morning Routine", points: 50, steps: ["Brush teeth", "Make bed", "Eat breakfast"], deadline: new Date().setHours(8, 30, 0) },
        { name: "Homework", points: 100, steps: ["Math exercises", "Read chapter 5", "Write summary"], deadline: new Date().setHours(16, 0, 0) },
        { name: "Chores", points: 30, steps: ["Take out trash", "Clean dishes", "Vacuum living room"], deadline: new Date().setHours(18, 0, 0) },
        { name: "Evening Routine", points: 40, steps: ["Shower", "Prepare clothes for tomorrow", "Read a book"], deadline: new Date().setHours(21, 30, 0) }
    ];

    const updateStats = (pointsDelta = 0) => {
        totalTasksEl.textContent = taskCount;
        totalPoints += pointsDelta;
        totalPointsEl.textContent = totalPoints;
    };

    const renderTask = (task) => {
        taskCount++;
        updateStats(task.points);

        const card = document.createElement("div");
        card.className = "card col-12 col-md-6 p-3 shadow-sm";
        card.innerHTML = `
            <div class="card-body">
                <h5 class="card-title">${task.name}</h5>
                <p class="text-muted">Points: <strong>${task.points}</strong> ðŸª™ | Deadline: <strong>${new Date(task.deadline).toLocaleString()}</strong></p>
                <ul class="list-group list-group-flush mb-2">
                    ${task.steps.map(s => `<li class="list-group-item">${s}</li>`).join('')}
                </ul>
                <button class="btn btn-outline-success btn-sm complete-btn">âœ… Mark as Complete</button>
            </div>
        `;
        taskContainer.appendChild(card);

        card.querySelector(".complete-btn").addEventListener("click", () => {
            card.classList.add("bg-success", "text-white");
            card.querySelector(".complete-btn").disabled = true;
            // Optionally send a POST request to backend to mark as complete
        });
    };

    // Render placeholder tasks
    placeholderTasks.forEach(renderTask);

    // Add new task
    document.getElementById("saveTaskBtn").addEventListener("click", () => {
        const name = document.getElementById("taskName").value.trim();
        const points = parseInt(document.getElementById("taskPoints").value) || 0;
        const deadline = new Date(document.getElementById("taskDeadline").value);
        const steps = document.getElementById("taskSteps").value.split(",").map(s => s.trim()).filter(s => s);

        if (!name || !deadline || steps.length === 0) return alert("Please fill all fields.");

        renderTask({name, points, steps, deadline});
        ["taskName","taskPoints","taskDeadline","taskSteps"].forEach(id => document.getElementById(id).value = "");
        bootstrap.Modal.getInstance(document.getElementById("newTaskModal")).hide();
    });
});
</script>

{% endblock %}
