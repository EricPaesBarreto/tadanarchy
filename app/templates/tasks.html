{% extends "base.html" %}
{% block content %}
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <a class="navbar-brand mx-auto fw-semibold" href="#">FocusBuddy Tasks</a>
    </div>
  </nav>

  <div class="container mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-semibold">ğŸ“‹ Current Tasks for the Day</h3>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newTaskModal">â• Add New Task</button>
    </div>

    <div id="taskContainer"></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
    <div id="familyToast" class="toast text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">âœ… Task pushed to Family Board!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="newTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Task</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="taskName" class="form-control mb-2" placeholder="Task name (e.g. Morning Routine)">
          <input type="number" id="taskPoints" class="form-control mb-2" placeholder="Points (e.g. 50)">
          <input type="datetime-local" id="taskDeadline" class="form-control mb-2" placeholder="Deadline">
          <textarea id="taskSteps" class="form-control" placeholder="Enter micro tasks separated by commas"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="saveTaskBtn">Add Task</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Task Information</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="infoBody"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="sleepModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h4>ğŸŒ™ Prepare for Sleep Mode</h4>
        <p>Dim lights, avoid screens, and relax before bedtime.</p>
        <button class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let taskCount = 0;
      const taskContainer = document.getElementById("taskContainer");
      const toast = new bootstrap.Toast(document.getElementById("familyToast"));

      const renderTask = (name, points, steps, deadline) => {
        taskCount++;
        const card = document.createElement("div");
        card.className = "card mb-4 shadow-sm task-card";
        card.dataset.name = name;
        card.dataset.points = points;
        card.dataset.deadline = deadline;

        let stepsHtml = steps.map(
          (s, i) => `
            <li class="list-group-item d-flex align-items-center">
              <input type="checkbox" class="form-check-input me-2 step-checkbox" id="task${taskCount}_step${i}">
              <label class="form-check-label" for="task${taskCount}_step${i}">${s.trim()}</label>
            </li>`
        ).join("");

        card.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Task #${taskCount}: ${name}</h5>
              <span class="badge bg-secondary">${points} ğŸª™</span>
            </div>
            <p class="text-muted mt-2 mb-1">Deadline: <strong>${new Date(deadline).toLocaleString()}</strong></p>
            <ul class="list-group list-group-flush mt-2 steps-list">${stepsHtml}</ul>
            <div class="d-flex flex-wrap gap-2 mt-3">
              <button class="btn btn-outline-info btn-sm info-btn">â„¹ï¸ Info</button>
              <button class="btn btn-outline-success btn-sm push-btn">ğŸ“¤ Push</button>
              <button class="btn btn-outline-warning btn-sm focus-btn">ğŸ¯ Focus</button>
              <button class="btn btn-outline-dark btn-sm sleep-btn">ğŸŒ™ Sleep</button>
            </div>
          </div>
        `;
        taskContainer.appendChild(card);

        card.querySelectorAll(".step-checkbox").forEach(chk => chk.addEventListener("change", () => checkCompletion(card)));
        card.querySelector(".info-btn").addEventListener("click", () => showInfo(card, steps));
        card.querySelector(".push-btn").addEventListener("click", () => toast.show());
        card.querySelector(".sleep-btn").addEventListener("click", () => new bootstrap.Modal(document.getElementById("sleepModal")).show());
        card.querySelector(".focus-btn").addEventListener("click", () => enterFocusMode(name, 25 * 60)); // 25 min timer
      };

      const checkCompletion = (card) => {
        const allDone = Array.from(card.querySelectorAll(".step-checkbox")).every(c => c.checked);
        if (allDone) showHooray(card.dataset.name, card.dataset.points);
      };

      const showHooray = (name, points) => {
        const overlay = document.createElement("div");
        overlay.className = "hooray-screen text-center";
        overlay.innerHTML = `
          <h1>ğŸ‰ Hooray!</h1>
          <h3 class="mt-3">You have completed <strong>${name}</strong>!</h3>
          <p class="lead mt-2">You earned <strong>${points}</strong> ğŸª™</p>
          <button class="btn btn-light mt-4" id="closeHooray">Continue</button>`;
        document.body.appendChild(overlay);
        document.getElementById("closeHooray").addEventListener("click", () => overlay.remove());
      };

      const showInfo = (card, steps) => {
        const html = `
          <p><strong>Task:</strong> ${card.dataset.name}</p>
          <p><strong>Points:</strong> ${card.dataset.points} ğŸª™</p>
          <p><strong>Deadline:</strong> ${new Date(card.dataset.deadline).toLocaleString()}</p>
          <ul>${steps.map(s => `<li>${s}</li>`).join("")}</ul>`;
        document.getElementById("infoBody").innerHTML = html;
        new bootstrap.Modal(document.getElementById("infoModal")).show();
      };

      // FOCUS MODE
      const enterFocusMode = (name, durationSec) => {
        document.body.innerHTML = `
          <div class="focus-mode d-flex flex-column justify-content-center align-items-center vh-100">
            <h1>ğŸ¯ Focus Mode</h1>
            <p class="lead mb-3">Stay focused on <strong>${name}</strong></p>
            <div class="timer" id="focusTimer"></div>
            <button class="btn btn-light btn-lg mt-4" id="exitFocus">Exit Focus Mode</button>
          </div>`;

        window.onbeforeunload = () => "You are in Focus Mode!";
        window.addEventListener("blur", () => alert("ğŸš« Stay focused!"));

        const timerDisplay = document.getElementById("focusTimer");
        let remaining = durationSec;

        const updateTimer = () => {
          const min = Math.floor(remaining / 60);
          const sec = remaining % 60;
          timerDisplay.textContent = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
          if (remaining <= 0) {
            clearInterval(interval);
            alert("âœ… Time's up! Great job staying focused!");
          }
          remaining--;
        };

        updateTimer();
        const interval = setInterval(updateTimer, 1000);

        document.getElementById("exitFocus").addEventListener("click", () => {
          clearInterval(interval);
          window.onbeforeunload = null;
          window.location.reload();
        });
      };

      // Add new task
      document.getElementById("saveTaskBtn").addEventListener("click", () => {
        const name = document.getElementById("taskName").value.trim();
        const points = document.getElementById("taskPoints").value.trim() || 0;
        const deadline = document.getElementById("taskDeadline").value;
        const steps = document.getElementById("taskSteps").value.split(",").filter(s => s.trim() !== "");

        if (!name || !deadline || steps.length === 0) {
          alert("Please fill all fields.");
          return;
        }

        renderTask(name, points, steps, deadline);
        ["taskName","taskPoints","taskDeadline","taskSteps"].forEach(id => document.getElementById(id).value="");
        bootstrap.Modal.getInstance(document.getElementById("newTaskModal")).hide();
      });

      // Demo task
      renderTask("Morning Routine", 50, ["Brush teeth","Make bed","Eat breakfast"], new Date().setHours(8,30,0));
    });
  </script>
{% endblock %}
